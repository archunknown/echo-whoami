---
import Layout from "../layouts/Layout.astro";
import Header from "../components/Header.astro";
import Hero from "../components/Hero.astro";
import ProjectCard from "../components/ProjectCard.astro";
import CertificationCard from "../components/CertificationCard.astro";
import StackSection from "../components/StackSection.astro";
import ContactForm from "../components/ContactForm.astro";
import Footer from "../components/Footer.astro";
import {
	getProfile,
	getPublishedProjects,
	getPublishedCertifications,
	getAllTechnologies,
} from "../services/api";
import { t } from "../utils/i18n";
import { marked } from "marked";

const profile = await getProfile();
const projects = await getPublishedProjects();
const certifications = await getPublishedCertifications();
const technologies = await getAllTechnologies();

const translatedProfile = profile
	? {
			...profile,
			bio: t(profile.bio, "en"),
			resume_url: t(profile.resume_url, "en"),
	  }
	: null;

const architectureText = profile?.architecture_text as {
	es?: string;
	en?: string;
};
const dataAnalyticsText = profile?.data_analytics_text as {
	es?: string;
	en?: string;
};

const translatedProjects = projects?.map((project) => ({
	...project,
	title: t(project.title, "en"),
	summary: t(project.summary, "en"),
	problem: t(project.problem, "en"),
	architecture: t(project.architecture, "en"),
	outcome: t(project.outcome, "en"),
}));

const translatedCertifications = certifications?.map((cert) => ({
	...cert,
	title: t(cert.title, "en"),
}));

const uiDictionary = {
	projects: "View Projects",
	github: "View GitHub",
	resume: "Download CV",
	problem: "Problem",
	architecture: "Architecture",
	outcome: "Outcome",
	privateRepo: "Private",
	certificationsTitle: "Certifications",
	stackTitle: "Tech Stack",
	architectureTitle: "System Architecture",
	dataTitle: "Data & Analytics",
	viewCredential: "View Credential",
	contactTitle: "Get in Touch",
	contactName: "Full Name",
	contactEmail: "Email Address",
	contactMessage: "Your Message",
	contactSubmit: "Send Message",
	contactSuccess: "Message sent successfully! I'll get back to you soon.",
	contactError: "There was an error sending the message. Please try again.",
};
---

<Layout
	title="echo-whoami — Portfolio"
	lang="en"
	description="Software engineer & data specialist. Projects, stack and contact."
>
	<div class="min-h-screen flex flex-col font-sans">
		<Header lang="en" />
		<main class="grow flex flex-col font-sans">
			{
				translatedProfile && (
					<Hero
						bio={translatedProfile.bio}
						resumeUrl={translatedProfile.resume_url || "#"}
						githubUrl={translatedProfile.github_url || "#"}
						avatarUrl={profile?.avatar_url || undefined}
						displayName={profile?.display_name || undefined}
						t={uiDictionary}
					/>
				)
			}

			<section
				id="proyectos"
				class="max-w-5xl mx-auto px-6 py-20 w-full flex flex-col gap-10 reveal-hidden"
			>
				<div class="flex flex-col gap-2">
					<p
						class="font-mono text-xs tracking-widest"
						style="color: var(--text-muted);"
					>
						002 — work
					</p>
					<h2
						class="text-3xl md:text-4xl font-black tracking-tight"
						style="color: var(--text-primary);"
					>
						{uiDictionary.projects}
					</h2>
				</div>
				<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
					{
						translatedProjects?.map((project) => (
							<ProjectCard project={project} t={uiDictionary} />
						))
					}
				</div>
			</section>

			{
				translatedCertifications && translatedCertifications.length > 0 && (
					<section
						id="certifications"
						class="max-w-5xl mx-auto px-6 py-20 w-full flex flex-col gap-10 reveal-hidden"
						style="border-top: 1px solid var(--border-subtle);"
					>
						<div class="flex flex-col gap-2">
							<p
								class="font-mono text-xs tracking-widest"
								style="color: var(--text-muted);"
							>
								003 — certifications
							</p>
							<h2
								class="text-3xl md:text-4xl font-black tracking-tight"
								style="color: var(--text-primary);"
							>
								{uiDictionary.certificationsTitle}
							</h2>
						</div>
						<div class="flex flex-col">
							{translatedCertifications.map((cert, i) => (
								<CertificationCard
									certification={cert}
									index={i}
									t={uiDictionary}
								/>
							))}
						</div>
					</section>
				)
			}

			{
				technologies && technologies.length > 0 && (
					<section
						id="stack"
						class="max-w-5xl mx-auto px-6 py-20 w-full reveal-hidden"
						style="border-top: 1px solid var(--border-subtle);"
					>
						<div class="flex flex-col gap-2 mb-10">
							<p
								class="font-mono text-xs tracking-widest"
								style="color: var(--text-muted);"
							>
								004 — stack
							</p>
							<h2
								class="text-3xl md:text-4xl font-black tracking-tight"
								style="color: var(--text-primary);"
							>
								{uiDictionary.stackTitle}
							</h2>
						</div>
						<StackSection technologies={technologies} />
					</section>
				)
			}

			{
				(architectureText?.en || profile?.architecture_image_url) && (
					<section
						id="architecture"
						class="max-w-5xl mx-auto px-6 py-20 w-full reveal-hidden"
						style="border-top: 1px solid var(--border-subtle);"
					>
						<div class="flex flex-col gap-2 mb-10">
							<p
								class="font-mono text-xs tracking-widest"
								style="color: var(--text-muted);"
							>
								005 — architecture
							</p>
							<h2
								class="text-3xl md:text-4xl font-black tracking-tight"
								style="color: var(--text-primary);"
							>
								{uiDictionary.architectureTitle}
							</h2>
						</div>
						<div class="grid grid-cols-1 md:grid-cols-2 gap-12 items-center">
							{architectureText?.en && (
								<div
									set:html={marked.parse(architectureText.en)}
									class="text-sm leading-relaxed [&>p]:mb-4 [&>strong]:font-black [&>ul]:list-none [&>ul]:pl-0 [&>ul]:mb-4 [&>a]:underline"
									style="color: var(--text-secondary);"
								/>
							)}
							{profile?.architecture_image_url && (
								<div
									class="w-full flex items-center justify-center p-4"
									style="border: 1px solid var(--border-subtle);"
								>
									<img
										src={profile.architecture_image_url}
										alt="System Architecture Diagram"
										loading="lazy"
										class="w-full h-auto max-h-[400px] object-contain"
										style="filter: grayscale(100%) contrast(1.1);"
									/>
								</div>
							)}
						</div>
					</section>
				)
			}

			{
				(dataAnalyticsText?.en ||
					profile?.data_analytics_image_url) && (
					<section
						id="data-analytics"
						class="max-w-5xl mx-auto px-6 py-20 w-full reveal-hidden"
						style="border-top: 1px solid var(--border-subtle);"
					>
						<div class="flex flex-col gap-2 mb-10">
							<p
								class="font-mono text-xs tracking-widest"
								style="color: var(--text-muted);"
							>
								006 — data & analytics
							</p>
							<h2
								class="text-3xl md:text-4xl font-black tracking-tight"
								style="color: var(--text-primary);"
							>
								{uiDictionary.dataTitle}
							</h2>
						</div>
						<div class="grid grid-cols-1 md:grid-cols-2 gap-12 items-center">
							{profile?.data_analytics_image_url && (
								<div
									class="w-full flex items-center justify-center p-4 order-last md:order-first"
									style="border: 1px solid var(--border-subtle);"
								>
									<img
										src={profile.data_analytics_image_url}
										alt="Data & Analytics"
										loading="lazy"
										class="w-full h-auto max-h-[400px] object-contain"
										style="filter: grayscale(100%) contrast(1.1);"
									/>
								</div>
							)}
							{dataAnalyticsText?.en && (
								<div
									set:html={marked.parse(
										dataAnalyticsText.en
									)}
									class="text-sm leading-relaxed [&>p]:mb-4 [&>strong]:font-black [&>ul]:list-none [&>ul]:pl-0 [&>ul]:mb-4 [&>a]:underline"
									style="color: var(--text-secondary);"
								/>
							)}
						</div>
					</section>
				)
			}

			<section
				id="contact"
				class="max-w-5xl mx-auto px-6 py-20 w-full reveal-hidden"
				style="border-top: 1px solid var(--border-subtle);"
			>
				<ContactForm
					t={{
						title: uiDictionary.contactTitle,
						nameLabel: uiDictionary.contactName,
						emailLabel: uiDictionary.contactEmail,
						messageLabel: uiDictionary.contactMessage,
						submitText: uiDictionary.contactSubmit,
						successMessage: uiDictionary.contactSuccess,
						errorMessage: uiDictionary.contactError,
					}}
				/>
			</section>
		</main>
		<Footer />
	</div>
</Layout>
