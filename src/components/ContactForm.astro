---
const { t } = Astro.props;
---

<div class="w-full max-w-xl reveal-hidden">
    <div id="success-message" class="hidden py-16 text-center">
        <p
            class="font-mono text-xs tracking-widest"
            style="color: var(--text-secondary);"
        >
            message sent ✓
        </p>
    </div>

    <form id="contact-form" class="flex flex-col gap-6">
        <div class="flex flex-col gap-2">
            <p
                class="font-mono text-xs tracking-widest mb-6"
                style="color: var(--text-muted);"
            >
                004 — contact
            </p>
            <h2
                class="text-3xl md:text-4xl font-black tracking-tight"
                style="color: var(--text-primary);"
            >
                {t.title || "Get in Touch"}
            </h2>
        </div>

        <div
            id="error-message"
            class="hidden p-4 font-mono text-xs"
            style="color: #ff4444; border: 1px solid #ff444433;"
        >
        </div>

        <div class="flex flex-col gap-1">
            <label
                for="name"
                class="font-mono text-xs tracking-widest"
                style="color: var(--text-muted);"
            >
                {t.nameLabel || "name"}
            </label>
            <input
                type="text"
                id="name"
                name="name"
                required
                class="w-full px-0 py-3 bg-transparent font-sans text-sm outline-none"
                style="color: var(--text-primary); border-bottom: 1px solid var(--border-default);"
                onfocus="this.style.borderBottomColor='var(--text-secondary)';"
                onblur="this.style.borderBottomColor='var(--border-default)';"
            />
        </div>

        <div class="flex flex-col gap-1">
            <label
                for="email"
                class="font-mono text-xs tracking-widest"
                style="color: var(--text-muted);"
            >
                {t.emailLabel || "email"}
            </label>
            <input
                type="email"
                id="email"
                name="email"
                required
                class="w-full px-0 py-3 bg-transparent font-sans text-sm outline-none"
                style="color: var(--text-primary); border-bottom: 1px solid var(--border-default);"
                onfocus="this.style.borderBottomColor='var(--text-secondary)';"
                onblur="this.style.borderBottomColor='var(--border-default)';"
            />
        </div>

        <div class="flex flex-col gap-1">
            <label
                for="message"
                class="font-mono text-xs tracking-widest"
                style="color: var(--text-muted);"
            >
                {t.messageLabel || "message"}
            </label>
            <textarea
                id="message"
                name="message"
                rows="4"
                required
                class="w-full px-0 py-3 bg-transparent font-sans text-sm outline-none resize-none"
                style="color: var(--text-primary); border-bottom: 1px solid var(--border-default);"
                onfocus="this.style.borderBottomColor='var(--text-secondary)';"
                onblur="this.style.borderBottomColor='var(--border-default)';"
            ></textarea>
        </div>

        <button
            type="submit"
            id="submit-btn"
            class="w-fit inline-flex items-center px-6 py-3 font-mono text-xs font-bold tracking-widest transition-all duration-200 mt-2"
            style="background: var(--text-primary); color: var(--bg-primary); border: 1px solid var(--text-primary);"
            onmouseover="this.style.background='transparent'; this.style.color='var(--text-primary)';"
            onmouseout="this.style.background='var(--text-primary)'; this.style.color='var(--bg-primary)';"
        >
            {t.submitText || "send"}
        </button>
    </form>
</div>

<script>
    import { supabase } from "../lib/supabase";

    const form = document.getElementById(
        "contact-form"
    ) as HTMLFormElement | null;
    const successMsg = document.getElementById("success-message");
    const errorMsg = document.getElementById("error-message");
    const submitBtn = document.getElementById(
        "submit-btn"
    ) as HTMLButtonElement | null;

    if (form && submitBtn && errorMsg && successMsg) {
        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            submitBtn.disabled = true;
            const originalText = submitBtn.innerText;
            submitBtn.innerText = "...";
            errorMsg.classList.add("hidden");

            const formData = new FormData(form);
            const name = formData.get("name")?.toString();
            const email = formData.get("email")?.toString();
            const message = formData.get("message")?.toString();

            if (!name || !email || !message) {
                errorMsg.textContent = "all fields are required.";
                errorMsg.classList.remove("hidden");
                submitBtn.disabled = false;
                submitBtn.innerText = originalText;
                return;
            }

            const { error } = await supabase
                .from("contact_messages")
                .insert([{ name, email, message }]);

            if (error) {
                console.error(error);
                errorMsg.textContent =
                    "error sending message. please try again.";
                errorMsg.classList.remove("hidden");
                submitBtn.disabled = false;
                submitBtn.innerText = originalText;
            } else {
                form.classList.add("hidden");
                successMsg.classList.remove("hidden");
            }
        });
    }
</script>
